<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WildVoice AI - Hunting Call Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a4a2a 0%, #6b3a1a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .record-btn {
            background: linear-gradient(145deg, #8B4513, #A0522D);
            transition: all 0.3s ease;
        }
        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .record-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .recording {
            background: #DC2626;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-2xl w-full mx-auto">
        <div class="bg-white/95 rounded-2xl shadow-2xl p-6 md:p-8">
            <!-- Header -->
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-green-900 mb-2">ü¶å WildVoice AI üéØ</h1>
                <p class="text-lg md:text-xl text-amber-800">Your AI Hunting Call Coach</p>
            </div>

            <!-- Call Selection -->
            <div class="mb-6">
                <label for="callType" class="block text-lg font-semibold mb-2 text-gray-800">1. Choose Your Call:</label>
                <select id="callType" class="w-full p-3 border-2 border-amber-400 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option>Elk Bugle</option>
                    <option>Turkey Yelp</option>
                    <option>Whitetail Deer Grunt</option>
                    <option>Mallard Duck Quack</option>
                    <option>Coyote Howl</option>
                </select>
            </div>

            <!-- Record Button -->
            <div class="text-center mb-6">
                 <label class="block text-lg font-semibold mb-2 text-gray-800">2. Record Your Call:</label>
                <button id="recordBtn" class="record-btn text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg">
                    üé§ Start Recording
                </button>
                <div id="status" class="mt-3 text-gray-600 h-6"></div>
            </div>

            <!-- Results -->
            <div id="results" class="hidden bg-amber-50 rounded-lg p-6">
                <h3 class="text-2xl font-bold mb-4 text-green-900">AI Analysis:</h3>
                <div id="feedback"></div>
            </div>
        </div>
        <footer class="text-center mt-4 text-white/70 text-sm">
            <p>Powered by Gemini. For educational purposes only.</p>
        </footer>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const feedback = document.getElementById('feedback');
        const callType = document.getElementById('callType');

        recordBtn.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstart = () => {
                        isRecording = true;
                        recordBtn.textContent = '‚èπÔ∏è Stop Recording';
                        recordBtn.classList.add('recording');
                        status.textContent = 'Recording...';
                        results.classList.add('hidden');
                        audioChunks = [];
                    };

                    mediaRecorder.onstop = () => {
                        isRecording = false;
                        recordBtn.textContent = 'üé§ Start Recording';
                        recordBtn.classList.remove('recording');
                        status.textContent = 'Processing your call...';
                        recordBtn.disabled = true;

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        analyzeAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                } catch (error) {
                    status.textContent = '‚ùå Microphone access denied. Please enable it in your browser settings.';
                    console.error('Microphone Error:', error);
                }
            }
        });

        async function analyzeAudio(audioBlob) {
            // Show loader
            results.classList.remove('hidden');
            feedback.innerHTML = '<div class="loader"></div><p class="text-center">Analyzing...</p>';

            // Convert audio to base64
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];

                const prompt = `
You are an expert hunting guide and wildlife biologist, specializing in animal vocalizations. Your name is "WildVoice AI".
Analyze the provided audio recording of a hunter attempting a ${callType.value}.

Provide a structured, constructive, and encouraging analysis in Markdown format.

Your analysis must include:
- **Overall Score:** A score out of 10, with a brief justification.
- **Pitch & Tone:** How well does the pitch match a real ${callType.value}? Is the tone correct (e.g., aggressive, calm, searching)?
- **Rhythm & Cadence:** Analyze the timing, duration, and pauses. Is it natural?
- **Realism:** How convincing is the call overall? Does it sound like a real animal?
- **Pro Tip for Improvement:** Offer one single, actionable tip that will make the biggest difference.

Keep the feedback concise, positive, and easy for a hunter of any skill level to understand.
`;

                try {
                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "audio/webm",
                                        data: base64Audio
                                    }
                                }
                            ]
                        }]
                    };
                    
                    // We use the gemini-2.0-flash model here, which doesn't require an explicit API key in this environment.
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const analysis = result.candidates[0].content.parts[0].text;
                        // A simple markdown to HTML converter
                        let htmlAnalysis = analysis
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\n/g, '<br>');
                        feedback.innerHTML = `<div class="prose prose-sm max-w-none">${htmlAnalysis}</div>`;
                        status.textContent = '‚úÖ Analysis Complete!';
                    } else {
                         throw new Error('No content in API response.');
                    }

                } catch (error) {
                    console.error('Gemini API error:', error);
                    status.textContent = '‚ö†Ô∏è AI analysis failed.';
                    feedback.innerHTML = `<p class="text-red-600">Sorry, something went wrong during the analysis. Please try again. If the problem persists, the audio clip may be too short or too long.</p>`;
                } finally {
                    recordBtn.disabled = false; // Re-enable the button
                }
            };
            reader.readAsDataURL(audioBlob);
        }
    </script>
</body>
</html>

